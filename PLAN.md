# Plan: react-native-automerge-generated

## Context

MindooDB depends on Automerge, which currently runs as WebAssembly inside JSC. This requires JSC (not Hermes), needs two `patch-package` patches, complex Metro config hacks, and does not work on Android at all. We want to replace the WASM backend with **native compiled Rust** via uniffi-bindgen-react-native (ubrn), which generates React Native Turbo Modules from UniFFI-annotated Rust.

**Goal:** Create the `react-native-automerge-generated` project — a React Native Turbo Module that exposes the Automerge Rust library via JSI, and a TypeScript adapter that plugs it into `@automerge/automerge/slim` via `UseApi()`.

**Location:** `/Users/klehmann/git/react-native-automerge-generated`

---

## Architecture

```
App TypeScript code
       |
@automerge/automerge/slim  <-  UseApi(nativeAdapter)
       |
useapi-adapter.ts  (maps generated Turbo Module API -> UseApi interface)
       |
src/generated/automerge.ts  (auto-generated TypeScript by ubrn)
       |  JSI (C++)
cpp/generated/automerge.cpp  (auto-generated C++ by ubrn)
       |  FFI (C ABI)
uniffi_automerge Rust crate  (forked from automerge-swift/rust/)
       |
automerge core Rust crate (v0.7.2 from crates.io)
```

The two **hand-written** components are:
1. **Rust UniFFI wrapper** (`rust/`) — adapted from automerge-swift, bumped to UniFFI 0.29
2. **UseApi adapter** (`src/useapi-adapter.ts`) — maps ubrn-generated TypeScript API to the `API` interface + `Automerge` class expected by `@automerge/automerge/slim`

Everything else (C++, iOS ObjC++, Android Kotlin, generated TypeScript FFI) is **auto-generated by ubrn**.

---

## Phase 1: Scaffold the project [DONE]

Created directory structure + config files:
- `package.json`, `ubrn.config.yaml`, `tsconfig.json`, `babel.config.js`, `react-native.config.js`, `.gitignore`
- `rust/Cargo.toml`, `rust/build.rs`, `rust/uniffi.toml`

## Phase 2: Port the Rust UniFFI wrapper from automerge-swift [DONE]

Copied from `github.com/automerge/automerge-swift/rust/src/` and adapted:
- Migrated 4 custom types from UniFFI 0.28 (`UniffiCustomTypeConverter` trait) to 0.29 (`custom_type!` macro):
  `obj_id.rs`, `actor_id.rs`, `change_hash.rs`, `cursor.rs`
- Updated `Cargo.toml`: uniffi 0.28.2 -> 0.29.3, removed `features = ["wasm"]`, added `"cdylib"` crate-type
- Copied as-is: `doc.rs`, `sync_state.rs`, `value.rs`, `scalar_value.rs`, `patches.rs`, `mark.rs`, `obj_type.rs`, `path.rs`, `change.rs`, `text_encoding.rs`, `automerge.udl`, `lib.rs`

## Phase 3: Generate React Native Turbo Module [DONE]

### 3.1 Install ubrn CLI
```bash
cargo install uniffi-bindgen-react-native
```

### 3.2 Build for iOS
```bash
ubrn build ios --config ubrn.config.yaml --and-generate
```

### 3.3 Build for Android
```bash
ubrn build android --config ubrn.config.yaml --and-generate
```

## Phase 4: Write the UseApi() adapter [DONE]

See `src/useapi-adapter.ts` — full implementation of NativeAutomerge class + nativeApi object.

## Phase 5: Integration testing [TODO]

### 5.1 Create example app
### 5.2 Verify with mindoodb

---

## What gets eliminated

Once this works, the following can be removed from the mindoodb React Native setup:
- `react-native+0.76.9.patch` (JSC createArrayBuffer fix) — not needed, no WASM
- `react-native-quick-crypto+1.0.7.patch` (randomFillSync crash) — still needed for crypto, but WASM memory issue goes away
- Metro resolver hacks (slim -> fullfat redirect) — not needed, no WASM
- `jsEngine: "jsc"` requirement — can use Hermes on both platforms
- WASM initialization code in index.js — not needed
- atob/btoa polyfills (for base64 WASM) — not needed
- `text-encoding` polyfill (for WASM) — may still be needed for other uses
